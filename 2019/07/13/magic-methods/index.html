<!DOCTYPE html><html xmlns:v-bind="http://www.w3.org/1999/xhtml"><head><meta name="generator" content="Hexo 3.9.0"><title>Class Magic Methods in Python - Avalon</title><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="John Reese"><meta name="description" content="__getattribute__ methodThis method usually implements a c..."><meta name="keywords" content><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name="viewport"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous"><link rel="stylesheet" href="/css/journal.css?33956222"><script src="/js/loadCSS.js"></script><script>loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Material+Icons"),function(e){var t,a={kitId:"dwg1tuc",scriptTimeout:3e3,async:!0},o=e.documentElement,s=setTimeout(function(){o.className=o.className.replace(/\bwf-loading\b/g,"")+" wf-inactive"},a.scriptTimeout),c=e.createElement("script"),i=!1,n=e.getElementsByTagName("script")[0];o.className+=" wf-loading",c.src="https://use.typekit.net/"+a.kitId+".js",c.async=!0,c.onload=c.onreadystatechange=function(){if(t=this.readyState,!(i||t&&"complete"!=t&&"loaded"!=t)){i=!0,clearTimeout(s);try{Typekit.load(a)}catch(e){}}},n.parentNode.insertBefore(c,n)}(document)</script><noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora|Montserrat|Anonymous+Pro:400|Material+Icons"></noscript><link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body><div id="top"></div><div id="app"><div class="single-column-drawer-container" ref="drawer" v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class="drawer-content"><div class="drawer-menu"><a class="a-block drawer-menu-item false" href="http://yoursite.com">Home </a><a class="a-block drawer-menu-item false" href="/archives">記事一覽 </a><a class="a-block drawer-menu-item false" href="/categories/index.html">分類 </a><a class="a-block drawer-menu-item false" href="/tags/index.html">標簽 </a><a class="a-block drawer-menu-item false" href="/about/index.html">關於我</a></div></div></div><transition name="fade"><div v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div></transition><nav ref="navBar" class="navbar sticky-top navbar-light single-column-nav-container"><div ref="navBackground" class="nav-background"></div><div class="container container-narrow nav-content"><button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer"><i class="material-icons">menu</i></button> <a ref="navTitle" class="navbar-brand" href="/">Avalon</a></div></nav><div class="single-column-header-container" ref="pageHead" v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href="/"><div class="single-column-header-title">Avalon</div><div class="single-column-header-subtitle">Welcome!!</div></a></div><div ref="sideContainer" class="side-container"><a class="a-block nav-head false" href="/"><div class="nav-title">远い理想郷</div><div class="nav-subtitle">お帰りなさい</div></a><div class="nav-link-list"><a class="a-block no-tint nav-link-item false" href="/archives">記事一覽 </a><a class="a-block nav-link-item false" href="/categories/index.html">分類 </a><a class="a-block nav-link-item false" href="/tags/index.html">標簽 </a><a class="a-block nav-link-item false" href="/about/index.html">關於我</a></div><div class="nav-footer">Proudly published with Hexo<br>Theme <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> by <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a><br>&copy; 2021 <a href="http://yoursite.com">Avalon</a></div></div><div ref="extraContainer" class="extra-container"><div class="pagination"><a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a></div></div><div ref="streamContainer" class="stream-container"><div class="post-list-container post-list-container-shadow"><div class="post"><div class="post-head-wrapper-text-only" style="background-image:url('')"><div class="post-title">Class Magic Methods in Python<div class="post-meta"><time datetime="2019-07-13T20:25:16.000Z" itemprop="datePublished">2019-07-13 16:25 </time>&nbsp; <i class="material-icons">folder</i> <a href="/categories/Python/">Python</a> <i class="material-icons">label</i> <a href="/tags/Python/">Python</a>, <a href="/tags/Magic-Methods/">Magic Methods</a></div></div></div><div class="post-body-wrapper"><div class="post-body"><h3 id="getattribute__-method">__getattribute__ method</h3><p>This method usually implements a class's getter to <strong>get</strong> whatever you request (<strong>attributes and methods</strong>) from an object/a class.<br>I don't know for sure the difference with <code>__getattr__</code>.</p><p>A common way of implementing this method is as follows:</p><div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">class</span> test:</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, lo<span class="op">=</span><span class="dv">1</span>, hi<span class="op">=</span><span class="dv">20</span>, size<span class="op">=</span><span class="dv">10</span>):</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">        <span class="va">self</span>.array <span class="op">=</span> np.random.randint(low<span class="op">=</span>lo, high<span class="op">=</span>hi, size<span class="op">=</span>size)</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">    <span class="kw">def</span> <span class="fu">__getattribute__</span>(<span class="va">self</span>, name):</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">        builtin_members <span class="op">=</span> [<span class="st">&#39;count&#39;</span>]</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">        <span class="cf">if</span> name <span class="kw">in</span> builtin_members: </a>
<a class="sourceLine" id="cb1-9" data-line-number="9">            <span class="cf">return</span> <span class="bu">super</span>().<span class="fu">__getattribute__</span>(name)</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">        </a>
<a class="sourceLine" id="cb1-11" data-line-number="11">    <span class="kw">def</span> count(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">        <span class="cf">return</span> np.size(<span class="va">self</span>.array)</a></code></pre></div><p><strong>Question</strong>: What is the following codes' output?</p><div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb2-1" data-line-number="1">t <span class="op">=</span> test()</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="bu">print</span>(t.count())</a></code></pre></div><p>The answer is 1.</p><p>And what about the results when we change the test's structure to this:</p><div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="im">import</span> numpy <span class="im">as</span> np</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">class</span> test:</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, lo<span class="op">=</span><span class="dv">1</span>, hi<span class="op">=</span><span class="dv">20</span>, size<span class="op">=</span><span class="dv">10</span>):</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">        <span class="va">self</span>.array <span class="op">=</span> np.random.randint(low<span class="op">=</span>lo, high<span class="op">=</span>hi, size<span class="op">=</span>size)</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"></a>
<a class="sourceLine" id="cb3-6" data-line-number="6">    <span class="kw">def</span> <span class="fu">__getattribute__</span>(<span class="va">self</span>, name):</a>
<a class="sourceLine" id="cb3-7" data-line-number="7">        builtin_members <span class="op">=</span> [<span class="st">&#39;count&#39;</span>]</a>
<a class="sourceLine" id="cb3-8" data-line-number="8">        <span class="cf">if</span> name <span class="kw">in</span> builtin_members: </a>
<a class="sourceLine" id="cb3-9" data-line-number="9">            <span class="cf">return</span> <span class="bu">super</span>().<span class="fu">__getattribute__</span>(name)</a>
<a class="sourceLine" id="cb3-10" data-line-number="10">        <span class="cf">else</span>:</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">            <span class="cf">return</span> <span class="bu">object</span>.<span class="fu">__getattribute__</span>(<span class="va">self</span>, name)</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">        </a>
<a class="sourceLine" id="cb3-13" data-line-number="13">    <span class="kw">def</span> count(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb3-14" data-line-number="14">        <span class="cf">return</span> np.size(<span class="va">self</span>.array)</a></code></pre></div><p>The answer is 10.</p><p>And the reason is 1. <code>test</code> inherits from <code>object</code>, so <code>super().__getattribute__(name)</code> is equivalent to <code>object.__getattribute__(self, name)</code>. 2. the first class doesn't implement the case when <strong>non-built-in members</strong> (which in this case is <code>array</code>) are retrieved, so it automatically returns <code>None</code> whose size is 1.</p><p>Sometimes, there are many other complex implementation of an attribute getter.</p><h3 id="iadd__-and-__add__-method">__iadd__ and __add__ method</h3><p>Methods like <code>__iadd__</code>are called to implement <a href="https://docs.python.org/3/reference/datamodel.html#object.__iadd__" target="_blank" rel="noopener">augmented arithmetic assignments</a>. Specifically, these two methods are the implementations of the operators <code>+=</code> and <code>+</code>. To overload these 2 operators, we must implement and override <code>__iadd__</code> and <code>__add__</code> methods of a class. If <code>__iadd__</code> is not implemented, the augmented assignment <code>+=</code> falls back to the normal methods. Originally, <code>x += y</code> is equivalent to <code>x = x.__iadd__(y)</code>. When <code>__iadd__</code> is not implemented, <code>__add__</code> or <code>__radd__</code> will be the alternative method to overload <code>+=</code>. We can look at some examples below</p><div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">class</span> A:</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, val):</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">        <span class="va">self</span>.val <span class="op">=</span> val</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">    <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">        <span class="cf">return</span> <span class="bu">str</span>(<span class="va">self</span>.val)</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">    <span class="kw">def</span> <span class="fu">__add__</span>(<span class="va">self</span>, other):</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">        <span class="cf">return</span> A(<span class="va">self</span>.val <span class="op">+</span> other.val)</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">    <span class="kw">def</span> <span class="fu">__iadd__</span>(<span class="va">self</span>, other):</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">        <span class="va">self</span>.val <span class="op">+=</span> other.val</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">        <span class="cf">return</span> <span class="va">self</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11">a1, a2 <span class="op">=</span> A(<span class="dv">1</span>), A(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb4-12" data-line-number="12">a3 <span class="op">=</span> a1 <span class="op">+</span> a2</a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="bu">print</span>(a1, a2, a3) <span class="co">#1, 2, 3</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14">a3 <span class="op">+=</span> a1</a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="bu">print</span>(a1, a2, a3) <span class="co">#1, 2, 4</span></a></code></pre></div><p>If <code>__iadd__</code> is to be implemented, then there are a few things to watch out for. Typically, <code>__iadd__</code> should attempt to do the operation in-place (modifying self) and return the result (which could be, but does not have to be, self). And consequently, <code>__iadd__</code> is implemented for mutable objects like <code>list</code>and <code>dict</code>. For immutable objects like <code>int</code> and <code>string</code>, <code>__iadd__</code> simply uses <code>__add__</code> or <code>__radd__</code> as alternatives to maintain the immutability. Let's look at a few examples to get familiar with this idea.</p><div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb5-1" data-line-number="1">a <span class="op">=</span> b <span class="op">=</span> [<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">a <span class="op">+=</span> [<span class="dv">2</span>]</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="bu">print</span>(b) <span class="co"># [1, 2]</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">a <span class="op">=</span> a <span class="op">+</span> [<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="bu">print</span>(b) <span class="co"># [1, 2]</span></a></code></pre></div><p>The above example clearly displays the difference between <code>__add__</code> and <code>__iadd__</code> on mutable lists. <code>a += [2]</code> changes what <code>a</code> is referencing but <code>a + [3]</code> simply returns a new list without changing <code>a</code> or <code>[3]</code>. The assignment <code>=</code> only makes <code>a</code> reference the new list but doesn't change what <code>b</code> references. Also, for lists, <code>a += [3]</code> is just like <code>a.append(ele)</code> because they both mutate the list in-place and maintain <code>a</code>'s reference while <code>a = a + [3]</code> returns a new list and performs an assignment and finally changing <code>a</code>'s reference.</p><div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb6-1" data-line-number="1">a <span class="op">=</span> b <span class="op">=</span> <span class="dv">32</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">a <span class="op">+=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">b <span class="op">+=</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="bu">print</span>(a, b) <span class="co"># 33, 33</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">a <span class="op">=</span> a <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">b <span class="op">=</span> b <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="bu">print</span>(a, b) <span class="co"># 34, 34</span></a></code></pre></div><p>For data of <code>int</code> types, <code>__iadd__</code> is the same as <code>__add__</code>. Then let's take a look at an <a href="https://docs.python.org/3/faq/programming.html#faq-augmented-assignment-tuple-error" target="_blank" rel="noopener">example</a> with unexpected errors concerning <code>__iadd__</code>.</p><div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb7-1" data-line-number="1">a_tuple <span class="op">=</span> ([<span class="dv">1</span>, <span class="dv">2</span>], [<span class="dv">3</span>])</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">a_tuple[<span class="dv">0</span>] <span class="op">+=</span> [<span class="dv">3</span>]</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">Traceback (most recent call last):</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">  ...</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="pp">TypeError</span>: <span class="st">&#39;tuple&#39;</span> <span class="bu">object</span> does <span class="kw">not</span> support item assignment</a></code></pre></div><p>As we can see, <code>+=</code> operations to a mutable list fails because it is at the same time an element of a immutable tuple. But if we take a look at <code>a_tuple[0]</code> and we will find <code>a_tuple[0]</code> has become <code>[1, 2, 3]</code> successfully. Why? If we recreate this process with intermediate results, we will get</p><div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb8-1" data-line-number="1">result <span class="op">=</span> a_tuple[<span class="dv">0</span>].<span class="fu">__iadd__</span>([<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">a_tuple[<span class="dv">0</span>] <span class="op">=</span> result</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">Traceback (most recent call last):</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">  ...</a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="pp">TypeError</span>: <span class="st">&#39;tuple&#39;</span> <span class="bu">object</span> does <span class="kw">not</span> support item assignment</a></code></pre></div><p>Simply speaking, the object <code>a_tuple[0]</code> references (which is <code>[1, 2]</code>) has been smoothly mutated to <code>[1, 2, 3]</code> because of <code>__iadd__</code>. However, <code>a_tuple[0] = result</code> serves to mutate the reference of <code>a_tuple</code>'s first element while it is prohibited by Python to maintain <code>tuple</code>'s immutability. However, we can make some minor changes to make this happen</p><div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb9-1" data-line-number="1">a_tuple <span class="op">=</span> ([<span class="dv">1</span>, <span class="dv">2</span>], [<span class="dv">3</span>])</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">a_tuple.append(<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="bu">print</span>(a_tuple) <span class="co"># ([1, 2, 3], [3])</span></a></code></pre></div><p>This actually doesn't change any reference within that tuple because the only different thing is the list instead of the reference. And this can be proved as below</p><div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb10-1" data-line-number="1">a_tuple <span class="op">=</span> ([<span class="dv">1</span>, <span class="dv">2</span>], [<span class="dv">3</span>])</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="bu">print</span>([<span class="bu">id</span>(x) <span class="cf">for</span> x <span class="kw">in</span> a_tuple]) <span class="co"># [1341325857224, 1341325857736]</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">a_tuple[<span class="dv">0</span>].append(<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="bu">print</span>([<span class="bu">id</span>(x) <span class="cf">for</span> x <span class="kw">in</span> a_tuple]) <span class="co"># [1341325857224, 1341325857736]</span></a></code></pre></div><p>In a summary, you cannot make the tuple reference different things but you can change what is inside the list as you leave the reference alone. For more info, please refer to the official docs <a href="https://docs.python.org/3/reference/simple_stmts.html#assignment-statements" target="_blank" rel="noopener">Python Assignment Statements</a>.</p></div></div><nav class="post-pagination"><a class="newer-posts" href="/2019/08/19/FIQT/">Previous post<br>Fixed Income Quant Trading </a><span class="page-number"></span> <a class="older-posts" href="/2019/06/24/hello-world/">Next post<br>Hello World</a></nav></div></div><div class="single-column-footer">Proudly published with Hexo<br>Theme <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> by <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a><br>&copy; 2021 <a href="http://yoursite.com">Avalon</a></div></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.4/dist/umd/popper.min.js" integrity="sha256-EGs9T1xMHdvM1geM8jPpoo8EZ1V1VRsmcJz8OByENLA=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.min.js" integrity="sha256-FtWfRI+thWlNz2sB3SJbwKx5PgMyKIVgwHCTwa3biXc=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/smooth-scroll@14.2.1/dist/smooth-scroll.polyfills.min.js" integrity="sha256-CI4Gq5E0io1Pv0xM3qPM+NUIOhbIBvC3GiN1Y4KhXpw=" crossorigin="anonymous"></script><script src="/js/journal.js?58291221"></script></body></html>